name: Supabase Backup (Working Version)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # Daily at midnight UTC

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. Install PostgreSQL client
      - name: Add PostgreSQL Repository
        run: |
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update

      - name: Install PostgreSQL 14 Client
        run: sudo apt-get install -y postgresql-client-14

      # 2. Force IPv4
      - name: Configure IPv4
        run: |
          echo "precedence ::ffff:0:0/96  100" | sudo tee -a /etc/gai.conf

      # 3. Create backup
      - name: Run Backup
        env:
          PGHOST: db.YOUR_PROJECT_REF.supabase.co
          PGPORT: 5432
          PGUSER: postgres
          PGPASSWORD: ${{ secrets.DB_PASSWORD }}
          PGDATABASE: postgres
        run: |
          # Test connection
          psql -c "SELECT 1" || exit 1
          
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          BACKUP_FILE="supabase_backup_$TIMESTAMP.pgdump"
          
          pg_dump -Fc -Z 6 -f "$BACKUP_FILE"
          
          if [ ! -s "$BACKUP_FILE" ]; then
            echo "Backup failed!"
            exit 1
          fi
          echo "BACKUP_FILE=$BACKUP_FILE" >> $GITHUB_ENV
